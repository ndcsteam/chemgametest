<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分子探險家：高中化學互動學習</title>
    <script src="https://cdn.jsdelivr.net/npm/smiles-drawer@1.2.0/dist/smiles-drawer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4CAF50',
                        danger: '#F44336',
                        warning: '#FFC107',
                        info: '#2196F3',
                        success: '#4CAF50',
                    }
                }
            }
        }
    </script>
</head>
<body class="dark:bg-gray-900 dark:text-white bg-gray-50 text-gray-900 transition-colors duration-300">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-primary">分子探險家</h1>
            <p class="text-lg dark:text-gray-300 text-gray-600">高中化學互動學習平台</p>
            <div class="mt-2 text-sm inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 p-2 rounded-md">
                這個工具幫助你探索分子結構和基本化學性質，適合高中化學學習
            </div>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- 左側面板: 分子查看器 -->
            <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-4">分子結構查看器</h2>
                
                <div class="mb-4">
                    <label class="block mb-2 font-medium">選擇一個常見分子:</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <button class="molecule-example p-2 border dark:border-gray-600 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-sm" data-smiles="CCO">
                            乙醇 (酒精)
                        </button>
                        <button class="molecule-example p-2 border dark:border-gray-600 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-sm" data-smiles="C1=CC=CC=C1">
                            苯
                        </button>
                        <button class="molecule-example p-2 border dark:border-gray-600 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-sm" data-smiles="CC(=O)OC1=CC=CC=C1C(=O)O">
                            阿司匹林
                        </button>
                        <button class="molecule-example p-2 border dark:border-gray-600 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-sm" data-smiles="O=C=O">
                            二氧化碳
                        </button>
                        <button class="molecule-example p-2 border dark:border-gray-600 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-sm" data-smiles="CN1C=NC2=C1C(=O)N(C(=O)N2C)C">
                            咖啡因
                        </button>
                        <button class="molecule-example p-2 border dark:border-gray-600 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-sm" data-smiles="CCCC">
                            丁烷
                        </button>
                    </div>
                </div>
                
                <div class="my-4 p-3 bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-800 rounded-md">
                    <h3 class="font-medium text-yellow-800 dark:text-yellow-200">什麼是SMILES?</h3>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300">SMILES是一種用文字表示分子結構的方法。例如，乙醇(CCO)表示2個碳原子加1個氧原子。若想嘗試輸入自己的SMILES，可從範例開始修改。</p>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2 font-medium">輸入或修改SMILES:</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input id="smiles-input" type="text" placeholder="例如: CCO (乙醇)" 
                               class="flex-1 p-3 border dark:border-gray-600 dark:bg-gray-700 rounded-md text-base">
                        <button id="render-btn" class="bg-primary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded">
                            顯示分子
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-medium">分子結構:</label>
                        <div class="text-sm">
                            <button id="clear-btn" class="text-danger hover:text-opacity-80">
                                清除
                            </button>
                        </div>
                    </div>
                    <div id="molecule-editor" class="h-64 bg-gray-100 dark:bg-gray-700 flex items-center justify-center rounded-md border dark:border-gray-600">
                        <div id="molecule-container" class="w-full h-full flex items-center justify-center">
                            <canvas id="molecule-canvas" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block mb-2 font-medium">3D模型示意圖:</label>
                    <div id="molecule-3d-viewer" class="h-64 bg-gray-100 dark:bg-gray-700 rounded-md border dark:border-gray-600"></div>
                </div>
            </div>

            <!-- 右側面板: 特性和活動 -->
            <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="tabs flex border-b dark:border-gray-600 mb-6">
                    <button class="tab-btn py-2 px-4 text-primary font-medium border-b-2 border-primary" data-tab="properties">
                        分子特性
                    </button>
                    <button class="tab-btn py-2 px-4 text-gray-500 dark:text-gray-400 font-medium border-b-2 border-transparent" data-tab="challenges">
                        分子挑戰
                    </button>
                    <button class="tab-btn py-2 px-4 text-gray-500 dark:text-gray-400 font-medium border-b-2 border-transparent" data-tab="quiz">
                        化學測驗
                    </button>
                </div>

                <div id="properties-tab" class="tab-content">
                    <h3 class="text-xl font-semibold mb-4">分子特性分析</h3>
                    <div id="properties-loading" class="hidden">
                        <div class="flex items-center justify-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
                        </div>
                        <p class="text-center text-gray-500 dark:text-gray-400">計算中...</p>
                    </div>
                    <div id="properties-content" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-1 gap-4 mb-6">
                            <div class="p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                                <h4 class="font-medium mb-2">基本特性</h4>
                                <div id="basic-properties" class="space-y-2 text-sm"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                                <h4 class="font-medium mb-2">物理特性</h4>
                                <div id="physical-properties" class="space-y-2 text-sm"></div>
                            </div>
                            <div class="p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700">
                                <h4 class="font-medium mb-2">化學特性</h4>
                                <div id="chemical-properties" class="space-y-2 text-sm"></div>
                            </div>
                        </div>
                        <div class="border dark:border-gray-600 rounded-md p-4 bg-gray-50 dark:bg-gray-700 mb-6">
                            <h4 class="font-medium mb-2">極性和溶解性比較</h4>
                            <div class="h-40">
                                <canvas id="polarity-chart"></canvas>
                            </div>
                        </div>
                        <div class="border dark:border-gray-600 rounded-md p-4 bg-gray-50 dark:bg-gray-700">
                            <h4 class="font-medium mb-2">日常生活應用</h4>
                            <div id="common-uses" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                    <div id="no-molecule-message" class="py-12 text-center text-gray-500 dark:text-gray-400">
                        請在左側選擇一個分子來查看它的特性
                    </div>
                </div>

                <div id="challenges-tab" class="tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4">分子挑戰</h3>
                    <div class="mb-6">
                        <p class="mb-4">嘗試找到符合挑戰條件的分子:</p>
                        <div id="current-challenge" class="p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 mb-4">
                            <h4 class="font-medium mb-2" id="challenge-title">挑戰 #1: 尋找極性分子</h4>
                            <p id="challenge-description" class="text-sm mb-4">找到一個含氧的分子，它的極性比丁烷強但比水弱。</p>
                            <div class="flex items-center">
                                <span class="mr-2 text-sm">進度:</span>
                                <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                                    <div id="challenge-progress" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="challenge-progress-text" class="ml-2 text-sm">0%</span>
                            </div>
                        </div>
                        <button id="check-challenge-btn" class="bg-primary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded w-full">
                            檢查我的分子
                        </button>
                    </div>
                    <div id="challenge-result" class="hidden p-4 border rounded-md mb-6">
                        <h4 class="font-medium mb-2">結果:</h4>
                        <p id="challenge-feedback" class="mb-4"></p>
                        <div class="flex justify-end">
                            <button id="next-challenge-btn" class="bg-secondary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded">
                                下一個挑戰
                            </button>
                        </div>
                    </div>
                    <div class="border dark:border-gray-600 rounded-md p-4 bg-gray-50 dark:bg-gray-700">
                        <h4 class="font-medium mb-2">完成的挑戰</h4>
                        <div id="completed-challenges" class="space-y-2 text-sm">
                            <p class="text-gray-500 dark:text-gray-400">尚未完成任何挑戰</p>
                        </div>
                    </div>
                </div>

                <div id="quiz-tab" class="tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4">化學知識測驗</h3>
                    <div id="quiz-container">
                        <div id="quiz-question" class="p-4 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 mb-4">
                            <h4 class="font-medium mb-2" id="question-title">問題 1:</h4>
                            <p id="question-text" class="mb-4">以下哪個物質最容易溶於水?</p>
                            <div id="answer-options" class="space-y-2">
                                <div class="flex items-center p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
                                    <input type="radio" name="quiz-answer" id="option-1" value="0" class="mr-2">
                                    <label for="option-1">乙醇</label>
                                </div>
                                <div class="flex items-center p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
                                    <input type="radio" name="quiz-answer" id="option-2" value="1" class="mr-2">
                                    <label for="option-2">丁烷</label>
                                </div>
                                <div class="flex items-center p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
                                    <input type="radio" name="quiz-answer" id="option-3" value="2" class="mr-2">
                                    <label for="option-3">汽油</label>
                                </div>
                                <div class="flex items-center p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
                                    <input type="radio" name="quiz-answer" id="option-4" value="3" class="mr-2">
                                    <label for="option-4">食用油</label>
                                </div>
                            </div>
                        </div>
                        <button id="submit-quiz-btn" class="bg-primary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded w-full mb-4">
                            提交答案
                        </button>
                        <div id="quiz-result" class="hidden p-4 border dark:border-gray-600 rounded-md mb-6">
                            <h4 class="font-medium mb-2">結果:</h4>
                            <p id="quiz-feedback" class="mb-4"></p>
                            <div class="flex justify-end">
                                <button id="next-question-btn" class="bg-secondary hover:bg-opacity-80 text-white font-medium py-2 px-4 rounded">
                                    下一題
                                </button>
                            </div>
                        </div>
                        <div class="border dark:border-gray-600 rounded-md p-4 bg-gray-50 dark:bg-gray-700">
                            <h4 class="font-medium mb-2">測驗統計</h4>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div class="p-2 border dark:border-gray-600 rounded-md">
                                    <div class="text-2xl font-bold" id="quiz-total">0</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">總題數</div>
                                </div>
                                <div class="p-2 border dark:border-gray-600 rounded-md">
                                    <div class="text-2xl font-bold text-success" id="quiz-correct">0</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">答對</div>
                                </div>
                                <div class="p-2 border dark:border-gray-600 rounded-md">
                                    <div class="text-2xl font-bold text-danger" id="quiz-incorrect">0</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">答錯</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>分子探險家 - 高中化學互動學習平台 &copy; 2023</p>
            <p class="mt-1">適合高中化學課程學習使用</p>
        </footer>
    </div>

    <script>
        // Support dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize application on window load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app');
            initApp();
        });

        // Main application state
        const appState = {
            currentMolecule: null,
            currentSMILES: '',
            challenges: [
                {
                    id: 1,
                    title: '挑戰 #1: 尋找極性分子',
                    description: '找到一個含氧的分子，它的極性比丁烷強但比水弱。提示：試試乙醇(CCO)或其他醇類。',
                    check: (properties) => {
                        const polarity = properties.polarity;
                        const oCount = properties.formula.match(/O/g) ? properties.formula.match(/O/g).length : 0;
                        let progress = 0;
                        let feedback = '';
                        
                        if (oCount === 0) {
                            progress = 0;
                            feedback = '你的分子不含氧原子，請選擇含氧的分子。';
                        } else if (polarity > 0.2 && polarity < 0.85) {
                            progress = 100;
                            feedback = '恭喜！你找到了一個合適的中等極性分子。極性值為' + polarity.toFixed(2) + '，介於非極性的丁烷(0.1)和高極性的水(1.0)之間。';
                        } else if (polarity <= 0.2) {
                            progress = 30;
                            feedback = '你的分子極性太低（' + polarity.toFixed(2) + '），接近丁烷的非極性特徵。嘗試加入更多的極性官能團，如-OH或-NH2。';
                        } else {
                            progress = 60;
                            feedback = '你的分子極性太強（' + polarity.toFixed(2) + '），接近水的高極性特徵。嘗試加入一些非極性部分，如碳鏈。';
                        }
                        
                        return { progress, feedback };
                    }
                },
                {
                    id: 2,
                    title: '挑戰 #2: 找到一個可能是酸的分子',
                    description: '找到一個化學結構上可能表現為酸的分子。提示：找含有-COOH（羧酸）或-OH（醇）官能團的分子。',
                    check: (properties) => {
                        const isAcid = properties.reactivity.acid === "可能是酸";
                        const oCount = properties.formula.match(/O/g) ? properties.formula.match(/O/g).length : 0;
                        const cCount = properties.formula.match(/C/g) ? properties.formula.match(/C/g).length : 0;
                        
                        let progress = 0;
                        let feedback = '';
                        
                        if (isAcid) {
                            progress = 100;
                            feedback = '恭喜！你找到了一個化學結構上可能表現為酸的分子。這類分子通常能夠釋放氫離子(H+)，呈現酸性特徵。';
                        } else if (oCount >= 2) {
                            progress = 70;
                            feedback = '接近了！你的分子含有足夠的氧原子，但可能還需要調整結構。試試加入-COOH（羧酸）官能團。';
                        } else if (oCount >= 1) {
                            progress = 40;
                            feedback = '你的分子含有氧原子，但通常酸分子需要更多的氧原子。試試修改結構以包含更多的氧。';
                        } else {
                            progress = 10;
                            feedback = '你的分子不太可能是酸，因為它不含氧原子。酸通常是含氧的有機化合物。';
                        }
                        
                        return { progress, feedback };
                    }
                },
                {
                    id: 3,
                    title: '挑戰 #3: 找到易溶於水的分子',
                    description: '找到一個水溶性好的分子（與「油」的特性相反）。提示：極性強的分子通常易溶於水。',
                    check: (properties) => {
                        const waterSolubility = properties.waterSolubility;
                        
                        let progress = 0;
                        let feedback = '';
                        
                        if (waterSolubility >= 0.7) {
                            progress = 100;
                            feedback = '太棒了！你找到了一個易溶於水的分子，水溶性值為' + waterSolubility.toFixed(2) + '。這類分子通常含有極性官能團，如-OH、-NH2或-COOH。';
                        } else if (waterSolubility >= 0.4) {
                            progress = 60;
                            feedback = '你的分子有一定的水溶性（' + waterSolubility.toFixed(2) + '），但還可以進一步提高。嘗試加入更多極性官能團。';
                        } else {
                            progress = 20;
                            feedback = '你的分子水溶性較差（' + waterSolubility.toFixed(2) + '），可能更容易溶於油而非水。嘗試減少碳氫鏈的長度，增加極性部分。';
                        }
                        
                        return { progress, feedback };
                    }
                }
            ],
            currentChallengeIndex: 0,
            completedChallenges: [],
            
            quizQuestions: [
                {
                    question: '以下哪個物質最容易溶於水?',
                    options: ['乙醇', '丁烷', '汽油', '食用油'],
                    correctAnswer: 0,
                    explanation: '乙醇(CH₃CH₂OH)分子中含有極性的-OH基團，能與水分子形成氫鍵，因此比其他選項更容易溶於水。丁烷、汽油和食用油都是非極性物質，不易溶於水。'
                },
                {
                    question: '下列哪種物質能導電?',
                    options: ['純水', '食鹽水溶液', '糖水', '酒精'],
                    correctAnswer: 1,
                    explanation: '食鹽(NaCl)溶於水後會解離成Na⁺和Cl⁻離子，這些離子能自由移動並傳導電流。純水、糖水和酒精中不含有可移動的離子，因此不能有效導電。'
                },
                {
                    question: '以下哪個特性可以幫助我們區分酸和鹼?',
                    options: ['沸點', '密度', 'pH值', '顏色'],
                    correctAnswer: 2,
                    explanation: 'pH值是測量溶液酸鹼度的標準。酸的pH值小於7，鹼的pH值大於7。酸和鹼的沸點、密度和顏色各不相同，不能作為普遍的區分標準。'
                },
                {
                    question: '為什麼肥皂能清洗油污?',
                    options: ['因為肥皂是酸性的', '因為肥皂能分解油污', '因為肥皂分子既有親水部分又有親油部分', '因為肥皂能增加水的溫度'],
                    correctAnswer: 2,
                    explanation: '肥皂分子有親水性的頭部和親油性的尾部。親油部分能溶解油污，而親水部分能與水結合，從而使油污從表面分離並被沖走。這種結構使肥皂成為表面活性劑。'
                },
                {
                    question: '下列哪個不是有機化合物的特徵?',
                    options: ['含有碳原子', '常溫下一般為液體或固體', '通常可以燃燒', '通常導電性好'],
                    correctAnswer: 3,
                    explanation: '大多數有機化合物不導電，因為它們通常不能形成離子。有機化合物的特徵包括含有碳原子、多數在常溫下為液體或固體、可以燃燒等。'
                },
                {
                    question: '為什麼油和水不互溶?',
                    options: ['油的密度比水小', '油分子和水分子的極性不同', '油的沸點比水高', '油的分子量比水大'],
                    correctAnswer: 1,
                    explanation: '水是極性分子，而油主要由非極性分子組成。極性相似的物質才容易互溶（相似相溶原理）。雖然油的密度確實比水小，但這只解釋了為什麼油浮在水上，而非不互溶的原因。'
                }
            ],
            currentQuizIndex: 0,
            quizStats: {
                total: 0,
                correct: 0,
                incorrect: 0
            }
        };

        function initApp() {
            // 即時設置事件監聽器
            setupEventListeners();
            
            // 初始化頁籤
            initTabs();
            
            // 初始化第一個挑戰和測驗
            updateChallengeDisplay();
            updateQuizDisplay();
            
            console.log("應用程式已初始化");
        }

        function setupEventListeners() {
            // Molecule rendering
            document.getElementById('render-btn').addEventListener('click', renderMolecule);
            document.getElementById('clear-btn').addEventListener('click', clearMolecule);
            
            // Example molecules
            document.querySelectorAll('.molecule-example').forEach(btn => {
                btn.addEventListener('click', () => {
                    const smiles = btn.dataset.smiles;
                    document.getElementById('smiles-input').value = smiles;
                    renderMolecule();
                });
            });
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    switchTab(tabId);
                });
            });
            
            // Challenge buttons
            document.getElementById('check-challenge-btn').addEventListener('click', checkChallenge);
            document.getElementById('next-challenge-btn').addEventListener('click', nextChallenge);
            
            // Quiz buttons
            document.getElementById('submit-quiz-btn').addEventListener('click', submitQuizAnswer);
            document.getElementById('next-question-btn').addEventListener('click', nextQuizQuestion);
            
            // Make quiz answer containers clickable
            document.querySelectorAll('#answer-options > div').forEach(option => {
                option.addEventListener('click', (e) => {
                    // If the click wasn't directly on the radio button
                    if (e.target.tagName !== 'INPUT') {
                        // Find the radio inside this container and toggle it
                        const radio = option.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                });
            });
        }

        function initTabs() {
            // Make properties tab active by default
            switchTab('properties');
        }

        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab content
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('text-primary', 'border-primary');
                    btn.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
                } else {
                    btn.classList.remove('text-primary', 'border-primary');
                    btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
                }
            });
        }

        function renderMolecule() {
            const smilesInput = document.getElementById('smiles-input').value.trim();
            
            if (!smilesInput) {
                const container = document.getElementById('molecule-container');
                container.innerHTML = '<div class="w-full h-full flex items-center justify-center text-danger">請輸入有效的SMILES字符串</div>';
                return;
            }
            
            try {
                // 純JavaScript實現，不再依賴RDKit
                // 直接儲存SMILES字符串
                appState.currentSMILES = smilesInput;
                
                // 創建一個模擬的分子對象
                appState.currentMolecule = createMoleculeFromSmiles(smilesInput);
                
                // 渲染2D結構
                render2DMolecule(smilesInput);
                
                // 渲染3D結構
                render3DMolecule(smilesInput);
                
                // 計算及顯示屬性
                calculateProperties(appState.currentMolecule);
                
                // 隱藏無分子消息
                document.getElementById('no-molecule-message').classList.add('hidden');
                
            } catch (error) {
                console.error('Rendering error:', error);
                const container = document.getElementById('molecule-container');
                container.innerHTML = '<div class="w-full h-full flex items-center justify-center text-danger">分子渲染錯誤，請檢查SMILES字符串格式</div>';
            }
        }
        
        // 從SMILES創建模擬分子
        function createMoleculeFromSmiles(smiles) {
            // 分析SMILES字符串獲取基本信息
            // 這是簡化的方法，實際的SMILES解析器複雜得多
            const atomCounts = {};
            
            // 計算碳原子
            const carbonMatches = smiles.match(/C/g);
            atomCounts.C = carbonMatches ? carbonMatches.length : 0;
            
            // 計算氧原子
            const oxygenMatches = smiles.match(/O/g);
            atomCounts.O = oxygenMatches ? oxygenMatches.length : 0;
            
            // 計算氮原子
            const nitrogenMatches = smiles.match(/N/g);
            atomCounts.N = nitrogenMatches ? nitrogenMatches.length : 0;
            
            // 計算卤素
            const halogenMatches = smiles.match(/([FClBrI])/g);
            atomCounts.Hal = halogenMatches ? halogenMatches.length : 0;
            
            // 估計鍵數 (非準確，僅用於演示)
            const doubleBonds = (smiles.match(/=/g) || []).length;
            const tripleBonds = (smiles.match(/#/g) || []).length;
            const ringClosures = (smiles.match(/[0-9]/g) || []).length / 2;
            const otherBonds = (smiles.match(/[\(\)]/g) || []).length;
            
            // 估計總原子數
            const totalAtoms = atomCounts.C + atomCounts.O + atomCounts.N + atomCounts.Hal;
            
            // 估計總鍵數
            const totalBonds = totalAtoms - 1 + doubleBonds + tripleBonds * 2 + ringClosures;
            
            // 估計分子量
            const mw = atomCounts.C * 12 + atomCounts.O * 16 + atomCounts.N * 14 + atomCounts.Hal * 19 + totalAtoms * 1;
            
            // 創建模擬分子對象
            return {
                smiles: smiles,
                atomCounts: atomCounts,
                totalAtoms: totalAtoms,
                totalBonds: Math.max(0, totalBonds),
                molecularWeight: mw,
                get_formula: function() {
                    let formula = '';
                    if (atomCounts.C > 0) formula += 'C' + (atomCounts.C > 1 ? atomCounts.C : '');
                    if (atomCounts.O > 0) formula += 'O' + (atomCounts.O > 1 ? atomCounts.O : '');
                    if (atomCounts.N > 0) formula += 'N' + (atomCounts.N > 1 ? atomCounts.N : '');
                    if (atomCounts.Hal > 0) formula += 'X' + (atomCounts.Hal > 1 ? atomCounts.Hal : '');
                    formula += 'H' + Math.round(totalAtoms * 1.5); // 粗略估計氫原子數
                    return formula;
                },
                get_mol_wt: function() {
                    return this.molecularWeight;
                },
                get_num_atoms: function() {
                    return this.totalAtoms;
                },
                get_num_bonds: function() {
                    return this.totalBonds;
                }
            };
        }

        function render2DMolecule(smiles) {
            try {
                if (!window.SmilesDrawer) {
                    throw new Error('SmilesDrawer 函式庫未正確載入');
                }
                
                // 獲取canvas元素
                const canvas = document.getElementById('molecule-canvas');
                
                // 確保canvas有正確的尺寸
                const container = document.getElementById('molecule-container');
                canvas.width = container.clientWidth || 300;
                canvas.height = container.clientHeight || 200;
                
                // 設置SmilesDrawer選項
                const options = {
                    width: canvas.width,
                    height: canvas.height,
                    bondThickness: 2,
                    shortBondLength: 0.8,
                    bondSpacing: 5.0,
                    atomVisualization: 'default',
                    isomeric: true,
                    debug: false,
                    terminalCarbons: true,
                    explicitHydrogens: true
                };
                
                console.log('Rendering 2D structure with SmilesDrawer', {smiles, canvasDimensions: {width: canvas.width, height: canvas.height}});
                
                // 創建SmilesDrawer實例
                const smilesDrawer = new SmilesDrawer.Drawer(options);
                
                // 解析SMILES並繪製結構
                SmilesDrawer.parse(smiles, function(tree) {
                    try {
                        // 使用canvas繪製
                        smilesDrawer.draw(tree, canvas, 'light', false);
                        console.log('2D structure drawn successfully on canvas');
                    } catch (drawError) {
                        console.error('Error during drawing:', drawError);
                        showDrawingError('繪製結構時發生錯誤');
                    }
                }, function(parseError) {
                    // 解析錯誤回調
                    console.error('SMILES parsing error:', parseError);
                    showDrawingError('無法解析SMILES結構');
                });
            } catch (error) {
                console.error('2D rendering error:', error);
                showDrawingError(`無法繪製2D結構: ${error.message}`);
            }
        }
        
        // 在canvas區域顯示錯誤信息
        function showDrawingError(message) {
            const canvas = document.getElementById('molecule-canvas');
            const ctx = canvas.getContext('2d');
            
            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 設置錯誤文本樣式
            ctx.fillStyle = '#F44336';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // 繪製錯誤信息
            ctx.fillText(message, canvas.width / 2, canvas.height / 2);
        }

        function render3DMolecule(smiles) {
            const viewer = document.getElementById('molecule-3d-viewer');
            viewer.innerHTML = '';
            
            try {
                // 獲取分子中的原子類型
                let hasCarbons = smiles.includes('C');
                let hasOxygens = smiles.includes('O');
                let hasNitrogens = smiles.includes('N');
                let hasHalogens = smiles.match(/([FClBrI])/g);
                
                // 創建一個更具代表性的3D分子模型
                let svgContent = '';
                
                // 根據分子類型生成不同的3D模型
                if (smiles === 'CCO') { // 乙醇
                    svgContent = `
                        <svg width="160" height="120" viewBox="0 0 160 120">
                            <!-- 碳原子 (灰色) -->
                            <circle cx="40" cy="60" r="12" fill="#909090" />
                            <circle cx="80" cy="60" r="12" fill="#909090" />
                            <!-- 氧原子 (紅色) -->
                            <circle cx="120" cy="60" r="12" fill="#FF4444" />
                            
                            <!-- 碳-碳鍵 -->
                            <line x1="40" y1="60" x2="80" y2="60" stroke="#333" stroke-width="3" />
                            <!-- 碳-氧鍵 -->
                            <line x1="80" y1="60" x2="120" y2="60" stroke="#333" stroke-width="3" />
                            
                            <!-- 氫原子 (較小的白色圓) -->
                            <circle cx="40" cy="40" r="6" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="30" cy="75" r="6" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="50" cy="75" r="6" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            
                            <circle cx="80" cy="40" r="6" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="90" cy="75" r="6" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            
                            <!-- 氧上的氫原子 -->
                            <circle cx="135" cy="50" r="6" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            
                            <!-- 氫鍵 -->
                            <line x1="40" y1="60" x2="40" y2="40" stroke="#333" stroke-width="1.5" />
                            <line x1="40" y1="60" x2="30" y2="75" stroke="#333" stroke-width="1.5" />
                            <line x1="40" y1="60" x2="50" y2="75" stroke="#333" stroke-width="1.5" />
                            
                            <line x1="80" y1="60" x2="80" y2="40" stroke="#333" stroke-width="1.5" />
                            <line x1="80" y1="60" x2="90" y2="75" stroke="#333" stroke-width="1.5" />
                            
                            <line x1="120" y1="60" x2="135" y2="50" stroke="#333" stroke-width="1.5" />
                            
                            <!-- 標籤 -->
                            <text x="40" y="60" text-anchor="middle" dy="1" font-size="10" fill="white">C</text>
                            <text x="80" y="60" text-anchor="middle" dy="1" font-size="10" fill="white">C</text>
                            <text x="120" y="60" text-anchor="middle" dy="1" font-size="10" fill="white">O</text>
                            
                            <text x="40" y="40" text-anchor="middle" font-size="8" fill="black">H</text>
                            <text x="30" y="75" text-anchor="middle" font-size="8" fill="black">H</text>
                            <text x="50" y="75" text-anchor="middle" font-size="8" fill="black">H</text>
                            <text x="80" y="40" text-anchor="middle" font-size="8" fill="black">H</text>
                            <text x="90" y="75" text-anchor="middle" font-size="8" fill="black">H</text>
                            <text x="135" y="50" text-anchor="middle" font-size="8" fill="black">H</text>
                        </svg>
                    `;
                } else if (smiles === 'C1=CC=CC=C1') { // 苯
                    svgContent = `
                        <svg width="160" height="160" viewBox="0 0 160 160">
                            <!-- 六角形框架 -->
                            <polygon points="80,30 130,60 130,120 80,150 30,120 30,60" 
                                     fill="rgba(200,200,200,0.2)" stroke="#333" stroke-width="1" />
                            
                            <!-- 碳原子 -->
                            <circle cx="80" cy="30" r="10" fill="#909090" />
                            <circle cx="130" cy="60" r="10" fill="#909090" />
                            <circle cx="130" cy="120" r="10" fill="#909090" />
                            <circle cx="80" cy="150" r="10" fill="#909090" />
                            <circle cx="30" cy="120" r="10" fill="#909090" />
                            <circle cx="30" cy="60" r="10" fill="#909090" />
                            
                            <!-- 鍵 -->
                            <line x1="80" y1="30" x2="130" y2="60" stroke="#333" stroke-width="3" />
                            <line x1="130" y1="60" x2="130" y2="120" stroke="#333" stroke-width="3" />
                            <line x1="130" y1="120" x2="80" y2="150" stroke="#333" stroke-width="3" />
                            <line x1="80" y1="150" x2="30" y2="120" stroke="#333" stroke-width="3" />
                            <line x1="30" y1="120" x2="30" y2="60" stroke="#333" stroke-width="3" />
                            <line x1="30" y1="60" x2="80" y2="30" stroke="#333" stroke-width="3" />
                            
                            <!-- 雙鍵表示 (π鍵的簡化表示) -->
                            <ellipse cx="80" cy="90" rx="30" ry="50" fill="none" stroke="#5D5CDE" stroke-width="2" stroke-dasharray="5,5" />
                            
                            <!-- 氫原子 -->
                            <circle cx="80" cy="10" r="5" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="150" cy="60" r="5" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="150" cy="120" r="5" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="80" cy="170" r="5" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="10" cy="120" r="5" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            <circle cx="10" cy="60" r="5" fill="#FFFFFF" stroke="#333" stroke-width="1" />
                            
                            <!-- 標籤 -->
                            <text x="80" y="33" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="130" y="63" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="130" y="123" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="80" y="153" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="30" y="123" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="30" y="63" text-anchor="middle" font-size="10" fill="white">C</text>
                        </svg>
                    `;
                } else if (smiles === 'O=C=O') { // 二氧化碳
                    svgContent = `
                        <svg width="160" height="80" viewBox="0 0 160 80">
                            <!-- 氧原子 -->
                            <circle cx="30" cy="40" r="12" fill="#FF4444" />
                            <!-- 碳原子 -->
                            <circle cx="80" cy="40" r="12" fill="#909090" />
                            <!-- 氧原子 -->
                            <circle cx="130" cy="40" r="12" fill="#FF4444" />
                            
                            <!-- 雙鍵 -->
                            <line x1="30" y1="35" x2="80" y2="35" stroke="#333" stroke-width="2" />
                            <line x1="30" y1="45" x2="80" y2="45" stroke="#333" stroke-width="2" />
                            
                            <line x1="80" y1="35" x2="130" y2="35" stroke="#333" stroke-width="2" />
                            <line x1="80" y1="45" x2="130" y2="45" stroke="#333" stroke-width="2" />
                            
                            <!-- 標籤 -->
                            <text x="30" y="43" text-anchor="middle" font-size="14" fill="white">O</text>
                            <text x="80" y="43" text-anchor="middle" font-size="14" fill="white">C</text>
                            <text x="130" y="43" text-anchor="middle" font-size="14" fill="white">O</text>
                        </svg>
                    `;
                } else if (smiles === 'CCCC') { // 丁烷
                    svgContent = `
                        <svg width="160" height="80" viewBox="0 0 160 80">
                            <!-- 碳原子 -->
                            <circle cx="20" cy="40" r="10" fill="#909090" />
                            <circle cx="60" cy="40" r="10" fill="#909090" />
                            <circle cx="100" cy="40" r="10" fill="#909090" />
                            <circle cx="140" cy="40" r="10" fill="#909090" />
                            
                            <!-- 碳-碳鍵 -->
                            <line x1="20" y1="40" x2="60" y2="40" stroke="#333" stroke-width="3" />
                            <line x1="60" y1="40" x2="100" y2="40" stroke="#333" stroke-width="3" />
                            <line x1="100" y1="40" x2="140" y2="40" stroke="#333" stroke-width="3" />
                            
                            <!-- 標籤 -->
                            <text x="20" y="43" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="60" y="43" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="100" y="43" text-anchor="middle" font-size="10" fill="white">C</text>
                            <text x="140" y="43" text-anchor="middle" font-size="10" fill="white">C</text>
                        </svg>
                    `;
                } else {
                    // 通用分子模型 (對於其他分子)
                    svgContent = `
                        <svg width="160" height="160" viewBox="0 0 160 160">
                            <!-- 背景球體 -->
                            <circle cx="80" cy="80" r="60" fill="rgba(200,200,200,0.2)" stroke="#333" stroke-width="1" />
                            
                            <!-- 根據分子成分添加原子 -->
                            ${hasCarbons ? '<circle cx="60" cy="60" r="15" fill="#909090" /><text x="60" y="65" text-anchor="middle" font-size="12" fill="white">C</text>' : ''}
                            ${hasCarbons ? '<circle cx="100" cy="60" r="15" fill="#909090" /><text x="100" y="65" text-anchor="middle" font-size="12" fill="white">C</text>' : ''}
                            ${hasOxygens ? '<circle cx="80" cy="110" r="15" fill="#FF4444" /><text x="80" y="115" text-anchor="middle" font-size="12" fill="white">O</text>' : ''}
                            ${hasNitrogens ? '<circle cx="40" cy="100" r="15" fill="#3333FF" /><text x="40" y="105" text-anchor="middle" font-size="12" fill="white">N</text>' : ''}
                            ${hasHalogens ? '<circle cx="120" cy="100" r="15" fill="#00FF00" /><text x="120" y="105" text-anchor="middle" font-size="12" fill="white">X</text>' : ''}
                            
                            <!-- 鍵連接 -->
                            ${hasCarbons && hasCarbons ? '<line x1="60" y1="60" x2="100" y2="60" stroke="#333" stroke-width="3" />' : ''}
                            ${hasCarbons && hasOxygens ? '<line x1="80" y1="60" x2="80" y2="110" stroke="#333" stroke-width="3" />' : ''}
                            ${hasCarbons && hasNitrogens ? '<line x1="60" y1="60" x2="40" y2="100" stroke="#333" stroke-width="3" />' : ''}
                            ${hasCarbons && hasHalogens ? '<line x1="100" y1="60" x2="120" y2="100" stroke="#333" stroke-width="3" />' : ''}
                        </svg>
                    `;
                }
                
                // 添加到界面
                viewer.innerHTML = `
                    <div class="w-full h-full flex flex-col items-center justify-center">
                        ${svgContent}
                        <div class="text-center text-xs mt-4 px-2">
                            ${getMoleculeModelDescription(smiles)}
                        </div>
                    </div>
                `;
                
                console.log('3D model created for: ' + smiles);
                
            } catch (error) {
                console.error('3D rendering error:', error);
                viewer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-danger">無法繪製3D結構: ${error.message}</div>`;
            }
        }
        
        // 根據SMILES獲取分子描述
        function getMoleculeModelDescription(smiles) {
            if (smiles === 'CCO') {
                return '乙醇分子的3D模型 - 2個碳原子(灰色)和1個氧原子(紅色)，以及相連的氫原子';
            } else if (smiles === 'C1=CC=CC=C1') {
                return '苯分子的3D模型 - 6個碳原子組成的環狀結構，具有特殊的π鍵(虛線圓表示)';
            } else if (smiles === 'O=C=O') {
                return '二氧化碳分子的3D模型 - 1個碳原子與2個氧原子通過雙鍵連接';
            } else if (smiles === 'CCCC') {
                return '丁烷分子的3D模型 - 4個碳原子以直鏈相連';
            } else {
                return `分子的簡化3D模型 (SMILES: ${smiles.substring(0, 20)}${smiles.length > 20 ? '...' : ''})`;
            }
        }

        function clearMolecule() {
            document.getElementById('smiles-input').value = '';
            
            // 清除Canvas而不是移除它
            const canvas = document.getElementById('molecule-canvas');
            if (canvas && canvas.getContext) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // 清除3D視圖
            document.getElementById('molecule-3d-viewer').innerHTML = '';
            
            // 隱藏属性，顯示提示訊息
            document.getElementById('properties-content').classList.add('hidden');
            document.getElementById('no-molecule-message').classList.remove('hidden');
            
            // 重置應用狀態
            appState.currentMolecule = null;
            appState.currentSMILES = '';
        }

        function calculateProperties(mol) {
            // Show loading state
            document.getElementById('properties-loading').classList.remove('hidden');
            document.getElementById('properties-content').classList.add('hidden');
            
            // Simulate calculation delay
            setTimeout(() => {
                try {
                    const properties = simulateDeepChemPrediction(mol);
                    displayMoleculeProperties(properties);
                    
                    // Hide loading, show content
                    document.getElementById('properties-loading').classList.add('hidden');
                    document.getElementById('properties-content').classList.remove('hidden');
                } catch (error) {
                    console.error('Property calculation error:', error);
                    document.getElementById('properties-loading').classList.add('hidden');
                    document.getElementById('no-molecule-message').classList.remove('hidden');
                    document.getElementById('no-molecule-message').textContent = '屬性計算錯誤';
                }
            }, 800);
        }

        function simulateDeepChemPrediction(mol) {
            // 取得基本特性
            const mw = mol.get_mol_wt();
            const formula = mol.get_formula();
            const numAtoms = mol.get_num_atoms();
            const numBonds = mol.get_num_bonds();
            
            // 計算各種原子數量
            const numOxygens = formula.match(/O(\d+)?/);
            const numNitrogens = formula.match(/N(\d+)?/);
            const numCarbons = formula.match(/C(\d+)?/);
            const numHalogens = formula.match(/([FClBrI])(\d+)?/);
            
            const oCount = numOxygens ? (numOxygens[1] ? parseInt(numOxygens[1]) : 1) : 0;
            const nCount = numNitrogens ? (numNitrogens[1] ? parseInt(numNitrogens[1]) : 1) : 0;
            const cCount = numCarbons ? (numCarbons[1] ? parseInt(numCarbons[1]) : 1) : 0;
            const halCount = numHalogens ? (numHalogens[2] ? parseInt(numHalogens[2]) : 1) : 0;
            
            // 計算物理及化學性質
            // 計算極性 (根據含氧和含氮原子數)
            const polarity = Math.min(1.0, Math.max(0.1, (oCount * 0.3 + nCount * 0.2) / (cCount + 1)));
            
            // 估計水溶性 (受極性影響)
            const waterSolubility = Math.min(1.0, Math.max(0.1, polarity - (cCount * 0.05)));
            
            // 估計熔點 (根據分子大小和鍵數)
            const meltingPoint = Math.min(300, Math.max(-100, (mw / 10) + (numBonds * 2) - 20));
            
            // 估計沸點
            const boilingPoint = meltingPoint + 100 + (cCount * 10);
            
            // 估計密度
            const density = Math.min(3.0, Math.max(0.5, 0.8 + (oCount * 0.1) + (nCount * 0.05)));
            
            // 估計反應活性
            const reactivity = {
                oxidation: oCount > 0 ? "低" : "高",
                reduction: nCount > 0 ? "中" : "低",
                acid: (oCount > 1 && cCount > 1) ? "可能是酸" : "非酸性",
                base: nCount > 0 ? "可能是鹼" : "非鹼性"
            };
            
            // 生成常見用途
            const commonUses = generateCommonUses(formula, cCount, oCount, nCount);
            
            return {
                molecularWeight: mw,
                formula: formula,
                numAtoms: numAtoms,
                numBonds: numBonds,
                
                // 物理性質
                polarity: polarity,
                waterSolubility: waterSolubility,
                meltingPoint: meltingPoint,
                boilingPoint: boilingPoint,
                density: density,
                
                // 化學性質
                reactivity: reactivity,
                
                // 日常應用
                commonUses: commonUses
            };
        }

        function generateCommonUses(formula, cCount, oCount, nCount) {
            // 根據分子組成推測可能的用途
            let uses = [];
            
            // 常見的簡單分子
            if (formula === "CH4") {
                uses.push("天然氣的主要成分");
                uses.push("用作燃料");
            } else if (formula === "C2H6O" || formula === "CCO") {
                uses.push("醫用酒精消毒");
                uses.push("化學實驗中的溶劑");
                uses.push("酒精飲料的主要成分");
            } else if (formula === "CO2" || formula === "O=C=O") {
                uses.push("碳酸飲料的氣泡成分");
                uses.push("植物光合作用的原料");
                uses.push("乾冰（固態二氧化碳）用於降溫");
            } else if (formula === "C6H6" || formula === "C1=CC=CC=C1") {
                uses.push("有機化學合成的基本原料");
                uses.push("溶劑（注意：有毒性）");
            } else if (formula === "CCCC") {
                uses.push("石油氣（丁烷）的成分");
                uses.push("打火機的燃料");
            }
            
            // 根據原子組成猜測
            if (cCount > 4 && oCount > 1) {
                uses.push("可能有香味，用於香料或食品添加劑");
            }
            
            if (cCount > 8 && oCount === 0) {
                uses.push("可能是烷烴，用作燃料或潤滑油");
            }
            
            if (oCount > 0 && nCount > 0) {
                uses.push("可能有生物活性，用於醫藥或農藥");
            }
            
            // 如果沒有找到特定用途，添加一些一般性描述
            if (uses.length === 0) {
                if (cCount > 0 && oCount === 0 && nCount === 0) {
                    uses.push("有機化合物，可能用於合成材料");
                } else if (oCount > 0) {
                    uses.push("含氧化合物，可能有特定用途");
                } else {
                    uses.push("化學研究或合成的原料");
                }
            }
            
            return uses;
        }

        function displayMoleculeProperties(properties) {
            // 顯示基本特性
            const basicPropsEl = document.getElementById('basic-properties');
            basicPropsEl.innerHTML = `
                <div class="flex justify-between">
                    <span>分子式:</span>
                    <span class="font-medium">${properties.formula}</span>
                </div>
                <div class="flex justify-between">
                    <span>分子量:</span>
                    <span class="font-medium">${properties.molecularWeight.toFixed(2)} 克/莫爾</span>
                </div>
                <div class="flex justify-between">
                    <span>原子數:</span>
                    <span class="font-medium">${properties.numAtoms} 個</span>
                </div>
                <div class="flex justify-between">
                    <span>鍵數:</span>
                    <span class="font-medium">${properties.numBonds} 個</span>
                </div>
            `;
            
            // 顯示物理特性
            const physicalPropsEl = document.getElementById('physical-properties');
            if (physicalPropsEl) {
                physicalPropsEl.innerHTML = `
                    <div class="flex justify-between">
                        <span>極性:</span>
                        <span class="font-medium">${getPolarityDescription(properties.polarity)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>水溶性:</span>
                        <span class="font-medium">${getSolubilityDescription(properties.waterSolubility)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>估計熔點:</span>
                        <span class="font-medium">${properties.meltingPoint.toFixed(0)}°C</span>
                    </div>
                    <div class="flex justify-between">
                        <span>估計沸點:</span>
                        <span class="font-medium">${properties.boilingPoint.toFixed(0)}°C</span>
                    </div>
                    <div class="flex justify-between">
                        <span>估計密度:</span>
                        <span class="font-medium">${properties.density.toFixed(2)} g/cm³</span>
                    </div>
                `;
            }
            
            // 顯示化學特性
            const chemicalPropsEl = document.getElementById('chemical-properties');
            if (chemicalPropsEl) {
                chemicalPropsEl.innerHTML = `
                    <div class="flex justify-between">
                        <span>氧化傾向:</span>
                        <span class="font-medium">${properties.reactivity.oxidation}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>還原傾向:</span>
                        <span class="font-medium">${properties.reactivity.reduction}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>酸性特徵:</span>
                        <span class="font-medium">${properties.reactivity.acid}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>鹼性特徵:</span>
                        <span class="font-medium">${properties.reactivity.base}</span>
                    </div>
                `;
            }
            
            // 顯示極性和溶解性圖表
            displayPolarityChart(properties);
            
            // 顯示日常應用
            displayCommonUses(properties.commonUses);
        }
        
        // 根據數值描述極性
        function getPolarityDescription(value) {
            if (value < 0.2) return "非極性";
            if (value < 0.4) return "微極性";
            if (value < 0.6) return "中等極性";
            if (value < 0.8) return "高極性";
            return "極高極性";
        }
        
        // 根據數值描述溶解性
        function getSolubilityDescription(value) {
            if (value < 0.2) return "難溶於水";
            if (value < 0.4) return "微溶於水";
            if (value < 0.6) return "部分溶於水";
            if (value < 0.8) return "易溶於水";
            return "高度可溶";
        }

        function displayPolarityChart(properties) {
            const ctx = document.getElementById('polarity-chart').getContext('2d');
            
            // 檢查是否已有圖表
            if (window.polarityChart) {
                window.polarityChart.destroy();
            }
            
            // 創建比較圖表
            window.polarityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['極性', '水溶性'],
                    datasets: [{
                        label: '當前分子',
                        data: [
                            properties.polarity,
                            properties.waterSolubility
                        ],
                        backgroundColor: '#5D5CDE'
                    },
                    {
                        label: '參考: 水',
                        data: [1.0, 1.0],
                        backgroundColor: '#4DA6FF'
                    },
                    {
                        label: '參考: 己烷',
                        data: [0.1, 0.05],
                        backgroundColor: '#FF8A5B'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: '值 (0-1)'
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (context.datasetIndex === 0) {
                                        if (context.dataIndex === 0) {
                                            return `極性: ${getPolarityDescription(value)} (${value.toFixed(2)})`;
                                        } else {
                                            return `水溶性: ${getSolubilityDescription(value)} (${value.toFixed(2)})`;
                                        }
                                    }
                                    return context.dataset.label + ': ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayCommonUses(uses) {
            const container = document.getElementById('common-uses');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (uses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">沒有找到常見用途</p>';
                return;
            }
            
            const usesList = document.createElement('ul');
            usesList.className = 'list-disc pl-5';
            
            uses.forEach(use => {
                const listItem = document.createElement('li');
                listItem.className = 'mb-1';
                listItem.textContent = use;
                usesList.appendChild(listItem);
            });
            
            container.appendChild(usesList);
        }

        function updateChallengeDisplay() {
            const challenge = appState.challenges[appState.currentChallengeIndex];
            
            document.getElementById('challenge-title').textContent = challenge.title;
            document.getElementById('challenge-description').textContent = challenge.description;
            document.getElementById('challenge-progress').style.width = '0%';
            document.getElementById('challenge-progress-text').textContent = '0%';
            
            // Hide result
            document.getElementById('challenge-result').classList.add('hidden');
        }

        function checkChallenge() {
            if (!appState.currentMolecule) {
                // 創建一個臨時的通知元素而不是使用alert
                const notificationEl = document.createElement('div');
                notificationEl.className = 'fixed top-4 right-4 bg-danger text-white p-3 rounded shadow-lg z-50';
                notificationEl.textContent = '請先繪製或選擇一個分子';
                document.body.appendChild(notificationEl);
                
                // 3秒後移除通知
                setTimeout(() => {
                    notificationEl.remove();
                }, 3000);
                return;
            }
            
            try {
                // Get current challenge
                const challenge = appState.challenges[appState.currentChallengeIndex];
                
                // Calculate properties for the current molecule
                const mol = appState.currentMolecule;
                const properties = simulateDeepChemPrediction(mol);
                
                // Check if the challenge is met
                const result = challenge.check(properties);
                
                // Update progress bar
                document.getElementById('challenge-progress').style.width = `${result.progress}%`;
                document.getElementById('challenge-progress-text').textContent = `${result.progress}%`;
                
                // Show result
                document.getElementById('challenge-result').classList.remove('hidden');
                document.getElementById('challenge-feedback').textContent = result.feedback;
                
                // If challenge is completed
                if (result.progress === 100 && !appState.completedChallenges.includes(challenge.id)) {
                    appState.completedChallenges.push(challenge.id);
                    updateCompletedChallenges();
                }
            } catch (error) {
                console.error('Challenge check error:', error);
                // 創建一個臨時的通知元素而不是使用alert
                const notificationEl = document.createElement('div');
                notificationEl.className = 'fixed top-4 right-4 bg-danger text-white p-3 rounded shadow-lg z-50';
                notificationEl.textContent = '挑戰檢查出錯';
                document.body.appendChild(notificationEl);
                
                // 3秒後移除通知
                setTimeout(() => {
                    notificationEl.remove();
                }, 3000);
            }
        }

        function nextChallenge() {
            // Move to next challenge in the list
            appState.currentChallengeIndex = (appState.currentChallengeIndex + 1) % appState.challenges.length;
            
            // Update challenge display
            updateChallengeDisplay();
        }

        function updateCompletedChallenges() {
            const container = document.getElementById('completed-challenges');
            
            if (appState.completedChallenges.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">尚未完成任何挑戰</p>';
                return;
            }
            
            container.innerHTML = '';
            
            appState.completedChallenges.forEach(id => {
                const challenge = appState.challenges.find(c => c.id === id);
                
                if (challenge) {
                    const el = document.createElement('div');
                    el.className = 'p-2 border dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700';
                    el.innerHTML = `
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-success mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span>${challenge.title}</span>
                        </div>
                    `;
                    container.appendChild(el);
                }
            });
        }

        function updateQuizDisplay() {
            const question = appState.quizQuestions[appState.currentQuizIndex];
            
            document.getElementById('question-title').textContent = `問題 ${appState.currentQuizIndex + 1}:`;
            document.getElementById('question-text').textContent = question.question;
            
            // Update options
            const optionsContainer = document.getElementById('answer-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'flex items-center p-2 border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer';
                optionEl.innerHTML = `
                    <input type="radio" name="quiz-answer" id="option-${index + 1}" value="${index}" class="mr-2">
                    <label for="option-${index + 1}">${option}</label>
                `;
                
                // Add click handler to the entire div
                optionEl.addEventListener('click', (e) => {
                    // If the click wasn't directly on the radio button
                    if (e.target.tagName !== 'INPUT') {
                        // Find the radio inside this container and check it
                        const radio = optionEl.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }
                });
                
                optionsContainer.appendChild(optionEl);
            });
            
            // Clear any previous selections
            document.querySelectorAll('input[name="quiz-answer"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Hide result
            document.getElementById('quiz-result').classList.add('hidden');
        }

        function submitQuizAnswer() {
            const selectedOption = document.querySelector('input[name="quiz-answer"]:checked');
            
            if (!selectedOption) {
                // 創建一個臨時的通知元素而不是使用alert
                const notificationEl = document.createElement('div');
                notificationEl.className = 'fixed top-4 right-4 bg-danger text-white p-3 rounded shadow-lg z-50';
                notificationEl.textContent = '請選擇一個答案';
                document.body.appendChild(notificationEl);
                
                // 3秒後移除通知
                setTimeout(() => {
                    notificationEl.remove();
                }, 3000);
                return;
            }
            
            const selectedAnswer = parseInt(selectedOption.value);
            const question = appState.quizQuestions[appState.currentQuizIndex];
            const isCorrect = selectedAnswer === question.correctAnswer;
            
            // Show result
            const resultEl = document.getElementById('quiz-result');
            resultEl.classList.remove('hidden');
            
            if (isCorrect) {
                resultEl.classList.remove('border-danger', 'bg-danger', 'bg-opacity-10');
                resultEl.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                document.getElementById('quiz-feedback').innerHTML = `
                    <div class="text-success mb-2">正確！</div>
                    <div>${question.explanation}</div>
                `;
                appState.quizStats.correct++;
            } else {
                resultEl.classList.remove('border-success', 'bg-success', 'bg-opacity-10');
                resultEl.classList.add('border-danger', 'bg-danger', 'bg-opacity-10');
                document.getElementById('quiz-feedback').innerHTML = `
                    <div class="text-danger mb-2">不正確。正確答案是: ${question.options[question.correctAnswer]}</div>
                    <div>${question.explanation}</div>
                `;
                appState.quizStats.incorrect++;
            }
            
            // Update stats
            appState.quizStats.total++;
            updateQuizStats();
        }

        function nextQuizQuestion() {
            // Move to next question
            appState.currentQuizIndex = (appState.currentQuizIndex + 1) % appState.quizQuestions.length;
            
            // Update question display
            updateQuizDisplay();
        }

        function updateQuizStats() {
            document.getElementById('quiz-total').textContent = appState.quizStats.total;
            document.getElementById('quiz-correct').textContent = appState.quizStats.correct;
            document.getElementById('quiz-incorrect').textContent = appState.quizStats.incorrect;
        }
    </script>
</body>
</html>
